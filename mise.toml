# Root mise.toml for GAIA monorepo
#
# mise manages tools (node, python, nx)
# nx manages task execution and caching
#
# Run 'mise tasks' to see all available tasks
# Documentation: https://docs.heygaia.io/developers/commands

[tools]
mprocs = "0.7.3"
python = "3.11"
node = "22"
"npm:mintlify" = "latest"
prek = "latest"
uv = "latest"

[env]
_.python.venv = { path = "apps/backend/.venv", create = true }
MISE_NODE_COREPACK = "1"

[hooks]
postinstall = "pnpm install"

[settings]
npm.package_manager = "pnpm" # Use pnpm as the package manager
experimental = true # Can setup hooks and advanced features

# Development Tasks
[tasks."dev:web"]
description = "Run ONLY web"
run = "nx dev web"

[tasks."dev:backend"]
description = "Run ONLY backend server"
run = "nx dev backend"

[tasks."dev:arq"]
description = "Run ONLY ARQ worker"
dir = "apps/backend"
run = "mise worker"

[tasks."dev:docs"]
description = "Run ONLY docs"
run = "nx dev docs"

[tasks."dev:full"]
description = "Run backend + web + arq + docker"
run = 'mprocs "nx dev backend" "nx dev web" "mise dev:arq" "docker compose up"'

[tasks.dev]
description = "Run backend + web + docker logs"
run = 'mprocs "nx dev backend" "nx dev web" "docker compose up"'

# Build Tasks (with Nx caching)
[tasks.build]
description = "Build all apps"
run = "nx run-many -t build"

[tasks."build:web"]
description = "Build web only"
run = "nx build web"

[tasks."build:docs"]
description = "Build docs only"
run = "nx build docs"

[tasks."build:affected"]
description = "Build only affected projects"
run = "nx affected -t build"

# Test Tasks (with Nx caching)
[tasks.test]
description = "Test all apps"
run = "nx run-many -t test"

[tasks."test:backend"]
description = "Test backend only"
run = "nx test backend"

[tasks."test:web"]
description = "Test web only"
run = "nx test web"

[tasks."test:affected"]
description = "Test only affected projects"
run = "nx affected -t test"

# Lint Tasks (with Nx caching and parallelism)
[tasks.lint]
description = "Lint all apps (parallel with caching)"
run = "nx run-many -t lint --parallel=3"

[tasks."lint:fix"]
description = "Lint and fix all apps"
run = "nx run-many -t lint:fix --parallel=3"

[tasks."lint:backend"]
description = "Lint backend only"
run = "nx lint backend"

[tasks."lint:web"]
description = "Lint web only"
run = "nx lint web"

[tasks."lint:affected"]
description = "Lint only affected projects (parallel with caching)"
run = "nx affected -t lint --parallel=3"

# Format Tasks (with Nx parallelism)
[tasks.format]
description = "Format all apps (parallel)"
run = "nx run-many -t format --parallel=3"

[tasks."format:check"]
description = "Check formatting for all apps (parallel with caching)"
run = "nx run-many -t format:check --parallel=3"

[tasks."format:backend"]
description = "Format backend only"
run = "nx format backend"

[tasks."format:web"]
description = "Format web only"
run = "nx format web"

[tasks."format:affected"]
description = "Format only affected projects (parallel)"
run = "nx affected -t format --parallel=3"

# Type-check Tasks (with Nx caching)
[tasks."type-check"]
description = "Type-check all apps (parallel with caching)"
run = "nx run-many -t type-check --parallel=3"

[tasks."type-check:affected"]
description = "Type-check only affected projects (parallel with caching)"
run = "nx affected -t type-check --parallel=3"

# Setup and Installation
[tasks."setup:env"]
description = "Check if environment files exist"
run = '''
if [ ! -f "apps/backend/.env" ] || [ ! -f "apps/web/.env" ]; then
    echo "‚ùå Environment files not found!"
    echo ""
    echo "Copy example files:"
    echo "  cp apps/backend/.env.example apps/backend/.env"
    echo "  cp apps/web/.env.example apps/web/.env"
    exit 1
fi
'''

[tasks."setup:backend"]
description = "Set up backend dependencies"
dir = "apps/backend"
run = "mise deps"
depends = ["setup:env"]

[tasks."setup:web"]
description = "Set up web dependencies"
dir = "apps/web"
run = "mise deps"

[tasks."setup:deps"]
description = "Install all dependencies"
depends = ["setup:backend", "setup:web"]

[tasks.setup]
description = "Complete project setup"
depends = ["setup:*"]
dir = "apps/backend"
run = "docker compose up -d && mise seed:models"

# Clean Tasks
[tasks.clean]
description = "Clean all apps"
run = "nx run-many -t clean"

[tasks."clean:nx"]
description = "Clean Nx cache"
run = "nx reset"

# Pre-commit hooks
[tasks."pre-commit"]
description = "Run all pre-commit checks (workspace mode)"
run = "prek run --all-files"

[tasks."pre-commit:install"]
description = "Install pre-commit hooks using prek"
run = "prek install"

[tasks."pre-commit:run"]
description = "Run pre-commit hooks on staged files"
run = "prek run"

[tasks."pre-commit:backend"]
description = "Run pre-commit checks for backend only"
run = "prek run apps/backend/"

[tasks."pre-commit:web"]
description = "Run pre-commit checks for web only"
run = "prek run apps/web/"

[tasks."pre-commit:uninstall"]
description = "Uninstall pre-commit hooks"
run = "prek uninstall"

# Nx-specific tasks
[tasks.graph]
description = "Show Nx project graph"
run = "nx graph"

[tasks."affected:graph"]
description = "Show affected projects graph"
run = "nx affected:graph"
