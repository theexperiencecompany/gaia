# ═══════════════════════════════════════════════════════════════════════════════
# GAIA Monorepo - Root mise.toml
# ═══════════════════════════════════════════════════════════════════════════════
#
# mise manages tools (node, python, nx) and task execution
# nx manages build caching and project graph
#
# Quick Start:
#   mise setup        # First-time setup (all apps)
#   mise dev          # Start API + web
#   mise tasks        # List all available tasks
#
# Documentation: https://docs.heygaia.io/developers/commands
# ═══════════════════════════════════════════════════════════════════════════════

experimental_monorepo_root = true

# ─────────────────────────────────────────────────────────────────────────────
# MONOREPO CONFIGURATION
# ─────────────────────────────────────────────────────────────────────────────
#
# Monorepo mode allows accessing sub-project tasks from root using // syntax:
#
#   mise //apps/api:lint           # Run api lint
#   mise //apps/api:dev            # Run api dev (no docker)
#   mise //apps/desktop:dist:mac   # Build macOS desktop app
#   mise //apps/bots/discord:dev   # Run discord bot
#   mise //...:lint                # Run lint in ALL config_roots
#
# From within a sub-project, tasks work without // syntax:
#   cd apps/api && mise lint       # Same as: mise //apps/api:lint
#   cd apps/desktop && mise dist:mac
#
# Root tasks (defined below) handle orchestration and docker setup:
#   mise dev          # docker + api + web (orchestrated)
#   mise dev:api      # docker + api (orchestrated)
#   mise lint         # lint all projects (orchestrated)
#
# When to use each:
#   - Root tasks (mise dev, mise lint) = orchestration + docker
#   - Monorepo tasks (mise //apps/api:dev) = direct app commands
#   - Local tasks (cd apps/api && mise dev) = when working in one app
#

# [monorepo]
# config_roots = [
#     "apps/api",
#     "apps/web",
#     "apps/desktop",
#     "apps/mobile",
#     "docs",
#     "apps/voice-agent",
#     "apps/bots/*",
# ]

# ─────────────────────────────────────────────────────────────────────────────
# TOOLS & ENVIRONMENT
# ─────────────────────────────────────────────────────────────────────────────

[tools]
python = "3.12"
node = "22"
uv = "latest"
prek = "0.2.23"
"npm:nx" = "latest"
"npm:mintlify" = "latest"

[env]
_.python.venv = { path = ".venv", create = true }
MISE_NODE_COREPACK = "1"

[settings]
experimental = true
task.monorepo_depth = 4
task.monorepo_exclude_dirs = ["node_modules", ".next", ".venv", "__pycache__", "dist", "build", ".expo"]

# ─────────────────────────────────────────────────────────────────────────────
# SETUP & INSTALLATION
# ─────────────────────────────────────────────────────────────────────────────

[tasks."setup:env"]
description = "Check if environment files exist for all apps"
run = '''
echo "Checking environment files..."
missing=""

# API (Manual check)
if [ ! -f "apps/api/.env" ]; then
    missing="$missing\n  cp apps/api/.env.example apps/api/.env"
fi

# Web (Auto-copy)
if [ ! -f "apps/web/.env" ] && [ -f "apps/web/.env.example" ]; then
    echo "Creating apps/web/.env from example (no secrets)"
    cp apps/web/.env.example apps/web/.env
fi

# Mobile (Auto-copy)
if [ ! -f "apps/mobile/.env" ] && [ -f "apps/mobile/.env.example" ]; then
    echo "Creating apps/mobile/.env from example (no secrets)"
    cp apps/mobile/.env.example apps/mobile/.env
fi

if [ -n "$missing" ]; then
    echo "ERROR: Missing API environment file!"
    echo ""
    echo "Please copy the example file (contains secrets):"
    echo -e "$missing"
    exit 1
fi
echo "Environment files ready"
'''

[tasks."setup:mobile"]
description = "Install mobile dependencies (Expo)"
dir = "apps/mobile"
run = "pnpm install"

[tasks."setup:desktop"]
description = "Install desktop dependencies (Electron)"
dir = "apps/desktop"
run = "pnpm install"

[tasks."setup:voice-agent"]
description = "Install voice agent dependencies + download models"
dir = "apps/voice-agent"
run = "uv sync && uv run python -m src download-files"

[tasks."setup:deps"]
description = "Install all project dependencies"
run = '''
echo "Installing all dependencies..."
pnpm install
echo "Installing API dependencies..."
(cd apps/api && uv sync --group backend --group dev)
echo "Installing voice-agent dependencies..."
(cd apps/voice-agent && uv sync)
echo "All dependencies installed"
'''

[tasks.setup]
description = "Complete project setup for all apps (API, Web, Desktop, Mobile, Voice)"
depends = ["setup:env", "setup:deps"]
run = '''
echo "Starting Docker services..."
nx run docker:docker:up
echo "Seeding AI models..."
(cd apps/api && uv run --group backend python scripts/seed_models.py --force)
echo ""
echo "Setup complete! Run 'mise dev' to start development servers."
'''

# ─────────────────────────────────────────────────────────────────────────────
# DEVELOPMENT COMMANDS
# ─────────────────────────────────────────────────────────────────────────────

[tasks.dev]
description = "Run API + web in parallel (starts Docker automatically)"
run = "nx run docker:docker:up && nx run-many -t dev --projects=api,web --parallel=2"

[tasks."dev:api"]
description = "Run ONLY API server (starts Docker automatically)"
run = "nx run docker:docker:up && nx dev api"

[tasks."dev:web"]
description = "Run ONLY web (starts Docker automatically)"
run = "nx run docker:docker:up && nx dev web"

[tasks."dev:mobile"]
description = "Run Mobile App + API (starts Docker automatically)"
run = "nx run docker:docker:up && nx run-many -t dev --projects=api,mobile --parallel=2"

[tasks."dev:bots"]
description = "Run ALL bots (Discord, Telegram, Slack) in parallel"
run = "nx run-many -t dev --projects=bot-discord,bot-telegram,bot-slack --parallel=3"

[tasks."dev:full"]
description = "Run API + web + arq worker + voice agent + all bots in parallel"
run = "nx run docker:docker:up && nx run-many -t dev,worker --projects=api,web,voice-agent,bot-discord,bot-telegram,bot-slack --parallel=7"

# ─────────────────────────────────────────────────────────────────────────────
# BUILD COMMANDS
# ─────────────────────────────────────────────────────────────────────────────

[tasks.build]
description = "Build all apps"
run = "nx run-many -t build"

[tasks."build:affected"]
description = "Build only affected projects"
run = "nx affected -t build"

# ─────────────────────────────────────────────────────────────────────────────
# TEST COMMANDS
# ─────────────────────────────────────────────────────────────────────────────

[tasks.test]
description = "Test all apps"
run = "nx run-many -t test"

[tasks."test:bots"]
description = "Test all bots (Discord, Slack, Telegram)"
run = "cd apps/bots && pnpm vitest run"

[tasks."test:affected"]
description = "Test only affected projects"
run = "nx affected -t test"

# ─────────────────────────────────────────────────────────────────────────────
# LINTING & FORMATTING
# ─────────────────────────────────────────────────────────────────────────────

[tasks.lint]
description = "Lint all apps (parallel with caching)"
run = "nx run-many -t lint --parallel=3"

[tasks."lint:fix"]
description = "Lint and fix all apps"
run = "nx run-many -t lint:fix --parallel=3"

[tasks."lint:affected"]
description = "Lint only affected projects (parallel with caching)"
run = "nx affected -t lint --parallel=3"

[tasks.format]
description = "Format and write changes to all apps (parallel)"
run = "nx run-many -t format --parallel=3"

[tasks."format:check"]
description = "Check formatting for all apps (parallel with caching)"
run = "nx run-many -t format:check --parallel=3"

[tasks."format:affected"]
description = "Format and write changes to affected projects (parallel)"
run = "nx affected -t format --parallel=3"

[tasks."type-check"]
description = "Type-check all apps (parallel with caching)"
run = "nx run-many -t type-check --parallel=3"

[tasks."type-check:affected"]
description = "Type-check only affected projects (parallel with caching)"
run = "nx affected -t type-check --parallel=3"

# ─────────────────────────────────────────────────────────────────────────────
# PRE-COMMIT HOOKS
# ─────────────────────────────────────────────────────────────────────────────

[tasks."pre-commit"]
description = "Run all pre-commit checks (workspace mode)"
run = "prek run --all-files"

[tasks."pre-commit:install"]
description = "Install pre-commit hooks using prek"
run = "prek install"

[tasks."pre-commit:run"]
description = "Run pre-commit hooks on staged files"
run = "prek run"

[tasks."pre-commit:api"]
description = "Run pre-commit checks for API only"
run = "prek run apps/api/"

[tasks."pre-commit:web"]
description = "Run pre-commit checks for web only"
run = "prek run apps/web/"

[tasks."pre-commit:uninstall"]
description = "Uninstall pre-commit hooks"
run = "prek uninstall"

# ─────────────────────────────────────────────────────────────────────────────
# CLEAN & MAINTENANCE
# ─────────────────────────────────────────────────────────────────────────────

[tasks.clean]
description = "Clean all apps"
run = "nx run-many -t clean"

[tasks."clean:nx"]
description = "Clean Nx cache"
run = "nx reset"

# ─────────────────────────────────────────────────────────────────────────────
# NX UTILITIES
# ─────────────────────────────────────────────────────────────────────────────

[tasks.graph]
description = "Show Nx project graph"
run = "nx graph"

[tasks."affected:graph"]
description = "Show affected projects graph"
run = "nx affected:graph"

# ─────────────────────────────────────────────────────────────────────────────
# CI/CD COMMANDS
# ─────────────────────────────────────────────────────────────────────────────

[tasks."ci:desktop"]
description = "Test desktop-release workflow locally with act (dry-run)"
run = "act release --job build -n --eventpath .github/test-events/release.json"

[tasks."ci:desktop:run"]
description = "Actually run desktop-release workflow locally with act"
run = "act release --job build --eventpath .github/test-events/release.json"

[tasks."ci:list"]
description = "List all available GitHub Actions workflows"
run = "act -l"

[tasks."ci:release-please"]
description = "Test release-please workflow locally with act (dry-run)"
run = "act push -n --job release-please"

[tasks."ci:quality"]
description = "Test main.yml quality-checks workflow (dry-run)"
run = "act pull_request -n --job quality-checks"

[tasks."ci:quality:run"]
description = "Actually run quality-checks locally with act"
run = "act pull_request --job quality-checks"

[tasks."ci:build"]
description = "Test build.yml workflow (dry-run)"
run = "act workflow_call -n -W .github/workflows/build.yml"

[tasks."ci:all"]
description = "List all jobs across all workflows"
run = "act -l --workflows .github/workflows/"

# DEAD CODE DETECTION
# ─────────────────────────────────────────────────────────────────────────────

[tasks."dead-code"]
description = "Check for dead code (summary view)"
run = "bash scripts/dead-code-check.sh"

[tasks."dead-code:verbose"]
description = "Check for dead code (detailed with file names)"
run = "bash scripts/dead-code-check.sh --verbose"

[tasks."dead-code:strict"]
description = "Check for dead code (fail on findings)"
run = "bash scripts/dead-code-check.sh --strict"
