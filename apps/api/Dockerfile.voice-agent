# Voice Agent Dockerfile
# Lightweight build specifically for the voice agent worker

FROM python:3.12-slim AS base
WORKDIR /app

# Copy uv installer
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Install minimal system dependencies
RUN apt-get update && \
  apt-get install -y --no-install-recommends \
  build-essential \
  curl \
  libpq-dev && \
  rm -rf /var/lib/apt/lists/*

# Copy dependency files
COPY pyproject.toml ./

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
  UV_COMPILE_BYTECODE=1 \
  UV_LINK_MODE=copy \
  UV_SYSTEM_PYTHON=1

# Install base dependencies + voice-agent group
RUN --mount=type=cache,target=/root/.cache/uv \
  uv pip install . --group voice_agent

# Copy entire app directory
COPY app/ ./app/

# Setup non-root user
RUN adduser --disabled-password --gecos '' appuser \
  && mkdir -p /home/appuser/.cache/huggingface \
  && chown -R appuser:appuser /home/appuser \
  && chown -R appuser:appuser /app

USER appuser
RUN python -m app.workers.voice_agent download-files

CMD ["python", "-m", "app.workers.voice_agent", "start"]
