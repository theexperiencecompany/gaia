name: Desktop Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build for (e.g., v1.0.0)'
        required: false

concurrency:
  group: desktop-release-${{ github.event.release.tag_name || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: mac
          - os: windows-latest
            target: win
          - os: ubuntu-latest
            target: linux

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
          
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build Desktop (${{ matrix.target }})
        run: nx dist:${{ matrix.target }} desktop
        env:
          NEXT_PUBLIC_API_BASE_URL: https://api.heygaia.io/api/v1/
        
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name || inputs.tag }}
          files: |
            apps/desktop/release/**/*.dmg
            apps/desktop/release/**/*.zip
            apps/desktop/release/**/*.exe
            apps/desktop/release/**/*.AppImage
            apps/desktop/release/**/*.deb
