name: Deploy to GCP

on:
  repository_dispatch:
    types: [deploy]
  workflow_dispatch:
  workflow_call:

concurrency:
  group: deploy-gcp-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  statuses: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    # Needed for OIDC ‚Üí WIF
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      # Keyless authentication using Workload Identity Federation (no service account keys needed)
      - name: Authenticate to Google Cloud via Workload Identity Federation
        uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker to use gcloud as credential helper
        run: gcloud auth configure-docker

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # SSH into GCP VM and deploy: pull latest code + images, restart containers
      - name: Deploy application on GCP VM
        env:
          GCP_ZONE: ${{ secrets.GCP_ZONE }}
        run: |
          gcloud compute ssh ubuntu@gaia-backend \
            --zone=$GCP_ZONE \
            --command="
              set -e
              cd /home/aryan/gaia

              # Discard any local changes (production should always match repo)
              git reset --hard HEAD
              git clean -fd

              git fetch origin
              git checkout master
              git pull origin master

              # Stop all containers before pulling to avoid volume mount issues
              docker compose -f infra/docker/docker-compose.prod.yml down

              docker compose -f infra/docker/docker-compose.prod.yml pull

              # Recreate services with updated images (respecting dependencies)
              docker compose -f infra/docker/docker-compose.prod.yml up -d --remove-orphans
              docker image prune -f
            "

      - name: Verify deployment
        env:
          GCP_ZONE: ${{ secrets.GCP_ZONE }}
        run: |
          # Check if containers are running properly
          output=$(gcloud compute ssh ubuntu@gaia-backend \
            --zone=$GCP_ZONE \
            --command="
              cd /home/aryan/gaia
              docker compose -f infra/docker/docker-compose.prod.yml ps
            ")

          echo "$output"

          # Fail if any containers are not in 'running' state
          if echo "$output" | grep -E '(Exit|Restarting|Dead)'; then
            echo "‚ùå Some containers are not healthy"
            exit 1
          fi

          echo "‚úÖ All containers are running"

      - name: Docker Cleanup
        env:
          GCP_ZONE: ${{ secrets.GCP_ZONE }}
        run: |
          gcloud compute ssh ubuntu@gaia-backend \
            --zone=$GCP_ZONE \
            --command="
              echo 'Starting Docker cleanup...'

              # Remove dangling images
              docker image prune -f

              # Remove stopped containers
              docker container prune -f

              # Remove unused networks
              docker network prune -f

              echo '‚úÖ Docker cleanup completed.'
            "

      - name: Notify to Discord
        if: always()
        uses: appleboy/discord-action@v1.2.0
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
          username: "Gaia Deploy Bot"
          color: ${{ job.status == 'success' && '#48f442' || '#ff6b6b' }}
          message: |
            üöÄ **Deployment to GCP**

            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Status:** ${{ job.status }}
            **Deployed by:** ${{ github.actor }}
            **Timestamp:** ${{ github.run_id }}
