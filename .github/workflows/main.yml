name: Quality Checks

on:
  pull_request:
    branches:
      - develop
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Nx SHAs
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: master

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.15.1"
          cache: "pnpm"

      - name: Setup uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Install workspace dependencies
        run: pnpm install --frozen-lockfile

      - name: Install backend dependencies
        run: uv sync --frozen --all-extras
        working-directory: apps/backend

      - name: Install mypy types
        run: uv run mypy --install-types --non-interactive
        working-directory: apps/backend

      - name: Run affected lint
        run: npx nx affected -t lint --parallel=3
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      - name: Run affected type-check
        run: npx nx affected -t type-check --parallel=3
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      - name: Run affected build
        run: npx nx affected -t build --parallel=3
        env:
          NEXT_PUBLIC_API_BASE_URL: "http://fake-api-for-build.example.com"
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      - name: Run affected tests
        run: npx nx affected -t test --parallel=3
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

  # Only trigger builds on master when checks pass
  trigger-build:
    needs: [quality-checks]
    if: github.ref == 'refs/heads/master'
    uses: ./.github/workflows/build.yml
    secrets: inherit
